name: Deploy Angular App to Azure Web App Service

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch: # Allow manual triggers

env:
  NODE_VERSION: '22.14.0'
  AZURE_WEBAPP_NAME: 'vorba-web-app-demo-2'
  AZURE_RESOURCE_GROUP: 'vorba-file-service-rg'
  DEPLOY_ENV: 'production'
  DEPLOY_ENV_ABBREV: 'prod'

jobs:
  # optionally, can use job build-and-deploy: ?
  build:
    runs-on: ubuntu-latest # at the time of writing: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

      # TODO: review tests
      #- name: Run tests
      #  run: npm run test:ci

      - name: Build Angular application
        run: |
          echo "=== BUILD STEP DEBUG ==="
          echo "Ubuntu version: $(lsb_release -rs)"
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "Current directory: $(pwd)"
          echo "Running: npm run build"
          
          # Run build with verbose output
          npm run build

      - name: Post build inspection
        run: |
          echo "=== POST-BUILD INSPECTION ==="
          echo "Build exit code: $?"
          echo "Dist directory exists: $(test -d dist/vorba-web && echo 'YES' || echo 'NO')"
          echo "Browser directory exists: $(test -d dist/vorba-web/browser && echo 'YES' || echo 'NO')"
          echo "Dist directory contents:"
          ls -la dist/ || echo "dist/ directory not found"
          ls -la dist/vorba-web/ || echo "dist/vorba-web/ directory not found"
          echo "Browser directory contents:"
          ls -la dist/vorba-web/browser/ || echo "dist/vorba-web/browser/ directory not found"
          
          if [ $? -ne 0 ]; then
            echo "Build failed - exiting"
            exit 1
          else
            echo "Build successful"
          fi

      # see angular.json fileReplacements
      #- name: Copy environment.ts file to dist
      #  run: cp src/environments/environment.${{ env.DEPLOY_ENV_ABBREV }}.ts dist/vorba-web/environment.ts

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/vorba-web/
          retention-days: 10
          if-no-files-found: error

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ./dist-files

      - name: Move browser files to root for deployment
        run: |
          echo "=== MOVING BROWSER FILES TO ROOT ==="
          echo "Current directory: $(pwd)"
          echo "Dist files directory contents:"
          ls -la dist-files/
          echo ""
          echo "Moving browser files to root..."
          mv dist-files/browser/* ./
          echo ""
          echo "Root directory contents after move:"
          ls -la
          echo "=== END MOVE ==="

      - name: Inspect deployment contents
        run: |
          echo "=== DEPLOYMENT INSPECTION ==="
          echo "Current directory: $(pwd)"
          echo ""
          echo "All files and directories:"
          ls -la
          echo ""
          echo "Directory structure:"
          tree . || find . -type d | head -15
          echo ""
          echo "HTML files:"
          find . -name "*.html" | head -5
          echo ""
          echo "JavaScript files:"
          find . -name "*.js" | head -10
          echo ""
          echo "CSS files:"
          find . -name "*.css" | head -5
          echo ""
          echo "Key files check:"
          if [ -f "index.html" ]; then
            echo "index.html found"
            echo "   Size: $(ls -lh index.html | awk '{print $5}')"
          else
            echo "index.html not found"
          fi
          
          if [ -f "main.js" ]; then
            echo "main.js found"
            echo "   Size: $(ls -lh main.js | awk '{print $5}')"
          else
            #echo "dist/main.js not found" # TODO: review this step, and if is better to make it part of the build process
            echo "main.js not found"
          fi
          if [ -d "node_modules" ]; then
            echo "node_modules found"
            echo "   Size: $(du -sh node_modules | awk '{print $1}')"
          else
            echo "node_modules not found"
          fi
          echo ""
          echo "File count by type:"
          echo "HTML files: $(find . -name '*.html' | wc -l)"
          echo "JS files: $(find . -name '*.js' | wc -l)"
          echo "CSS files: $(find . -name '*.css' | wc -l)"
          echo "Total files: $(find . -type f | wc -l)"
          echo ""
          echo "PDF Viewer assets check:"
          if [ -f "assets/pdf.sandbox-5.4.793.mjs" ]; then
            echo "✓ PDF sandbox found"
          else
            echo "✗ PDF sandbox missing"
          fi
          if [ -f "assets/pdf.worker-5.4.793.mjs" ]; then
            echo "✓ PDF worker found"
          else
            echo "✗ PDF worker missing"
          fi
          if [ -f "assets/viewer-5.4.793.mjs" ]; then
            echo "✓ PDF viewer found"
          else
            echo "✗ PDF viewer missing"
          fi
          if [ -d "assets/wasm" ]; then
            echo "✓ WASM directory found"
          else
            echo "✗ WASM directory missing"
          fi
          echo ""
          echo "=== END INSPECTION ==="

      - name: 'Deploy to Azure Web App'
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          #slot-name: 'production'
          publish-profile: ${{ secrets.AZ_WEBAPP_PUB_PRFL__VORBA_WEB_2 }}
          #package: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
          package: ./